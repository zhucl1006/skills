---
name: project-workflow
description: |
  文档驱动的项目开发工作流。按 SOP 执行项目开发任务：读取文档索引 → 查找/制定计划 → 按步骤执行 → 更新文档。
  
  触发场景：
  - 用户请求开发新功能或模块
  - 用户说"开始开发"、"执行计划"、"继续上次的任务"
  - 需要按 plans/ 目录中的计划文件执行开发任务
  - 项目包含 docs/ 和 plans/ 目录结构
---

# Project Workflow

文档驱动的项目开发工作流，确保每次开发任务都有据可循、可追溯。

## 核心流程

```
1. 读取文档 → 2. 查找计划 → 3. [制定计划] → 4. 执行计划 → 5. 更新文档
```

---

## Phase 1: 读取项目文档

**每次执行前必须完成。**

```
1. 读取 docs/README.md 获取文档索引
2. 根据索引读取任务相关的文档：
   - 规格文档 (specs/)
   - 模块文档 (modules/)
   - 开发指南 (guides/)
3. 读取 AGENTS.md（如存在）了解项目约定
```

**关键文档优先级：**
- 架构设计 (SAD.md) > 需求文档 (PRD.md) > 模块文档 > 指南

---

## Phase 2: 查找执行计划

检查 `plans/` 目录下是否存在对应任务的计划文件。

**计划文件命名规范：**
```
plans/
├── 001-user-authentication.md
├── 002-llm-service-integration.md
├── 003-ocr-module.md
└── ...
```

**查找逻辑：**
```
1. ls plans/ 查看所有计划文件
2. 根据用户请求匹配对应计划
3. 如找到 → 进入 Phase 4 执行
4. 如未找到 → 进入 Phase 3 制定计划
```

---

## Phase 3: 制定计划（无计划时）

与用户沟通需求，创建计划文件。

### 3.1 需求澄清

向用户确认：
- 功能边界：具体要实现什么？
- 技术约束：有特殊技术要求吗？
- 验收标准：怎样算完成？
- 优先级：哪些是必须的，哪些可以后续迭代？

### 3.2 创建计划文件

**文件路径：** `plans/{序号}-{功能名}.md`

**序号规则：** 三位数字，从现有最大序号 +1

**计划模板：** 见 [references/plan-template.md](references/plan-template.md)

---

## Phase 4: 执行计划

按计划文件中的任务清单逐步执行。

### 4.1 执行前

```
1. 读取计划文件完整内容
2. 使用 TodoWrite 创建任务列表，将计划中的任务转为 todos
3. 将计划状态更新为"进行中"
```

### 4.2 执行中

```
对于每个任务：
  1. 标记 todo 为 in_progress
  2. 参考相关文档执行任务
  3. 运行测试/验证
  4. 标记 todo 为 completed
  5. 更新计划文件中的任务状态 [x]
  6. 在执行记录表格中添加记录
```

**执行原则：**
- 遵循项目 AGENTS.md 中的 CONVENTIONS 和 ANTI-PATTERNS
- 遵循 TDD：先写测试，再实现
- 每完成一个任务立即更新计划文件

### 4.3 执行后

```
1. 确认所有任务完成
2. 运行完整测试套件
3. 将计划状态更新为"已完成"
4. 进入 Phase 5 更新文档
```

---

## Phase 5: 更新文档

任务完成后，更新受影响的文档。

**必须检查并更新的文档：**

| 变更类型 | 需更新的文档 |
|----------|-------------|
| 新增模块 | docs/modules/{module}.md, docs/specs/SAD.md |
| API 变更 | docs/api/*.md |
| 数据库变更 | docs/database/SCHEMA.md |
| 新增功能 | docs/specs/PRD.md |
| 架构调整 | docs/specs/SAD.md, AGENTS.md |

**更新 AGENTS.md：**
- 如有新的约定或反模式，添加到对应章节
- 更新 CHANGELOG 记录变更

---

## 异常处理

| 场景 | 处理方式 |
|------|----------|
| 无 docs/ 目录 | 询问用户项目文档位置，或提议创建基础文档结构 |
| 无 plans/ 目录 | 创建 plans/ 目录，进入 Phase 3 |
| 计划执行中断 | 恢复时读取计划文件，从未完成任务继续 |
| 任务执行失败 | 记录失败原因到执行记录，询问用户处理方式 |
| 需求变更 | 更新计划文件，标记原任务状态，添加新任务 |
